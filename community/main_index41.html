<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>커뮤니티 게시판</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        .hidden {
            display: none;
        }

        body{
      margin: 0;
      padding: 0;
    }
    .title-wrapper{
      background-color: #f9d6e8;
      height: 50px;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .title{
      font-size: 30px;
      font-weight: bold;
      color: #ffffff;
      font-family: "맑은 고딕", "Arial", sans-serif;
    }

    .comments-list {
        list-style-type: none;
        padding: 0;
    }
    </style>
</head>

<body>
    <div class="title-wrapper">
        <span class="title">나혼자살래</span>
      </div>
    <div class="container">
        <h1 class="my-4">커뮤니티 게시판</h1>
        <div>
            <button id="writeButton" onclick="showPostWrite();" class="btn btn-primary mb-4">글 작성하기</button>
            <button id="topPostsButton" onclick="showTopPosts();" class="btn btn-info mb-4">추천글 보기</button>
            <ul id="post-list" class="post-list list-group">
            </ul>
            <form id="post-write-form" class="post-write hidden" onsubmit="return false;">
                <div class="form-group">
                    <label for="post-title">제목</label>
                    <input type="text" class="form-control" id="post-title" placeholder="제목을 입력하세요">
                </div>
                <div class="form-group">
                    <label for="post-content">내용</label>
                    <textarea class="form-control" id="post-content" rows="5" placeholder="내용을 입력하세요"></textarea>
                </div>
                <div class="form-group">
                    <label for="post-image">이미지 첨부</label>
                    <input type="file" class="form-control-file" id="post-image" accept="image/*">
                </div>
                <!-- 추가: 유튜브 URL 입력 요소 -->
                <div class="form-group">
                    <label for="youtube-url">유튜브 URL (옵션):</label>
                    <input type="text" class="form-control" id="youtube-url" placeholder="유튜브 주소를 입력하세요">
                </div>
                <button onclick="savePost();" class="btn btn-primary">작성완료</button>
                <button onclick="showPostList();" type="button" class="btn btn-secondary">취소</button>
            </form>
            <div id="post-view" class="post-view hidden">
            </div>
        </div>
    </div>

    <script>
        let currentPostIndex;
        const savedPosts = [];
        const postListElem = document.getElementById('post-list');
        const postWriteForm = document.getElementById('post-write-form');
        const postView = document.getElementById('post-view');

        function resetForm() {
            document.getElementById('post-title').value = '';
            document.getElementById('post-content').value = '';
            document.getElementById('post-image').value = '';
            document.getElementById('youtube-url').value = ''; // 추가
        }

        function showPostWrite() {
            postListElem.classList.add('hidden');
            postWriteForm.classList.remove('hidden');
            postView.classList.add('hidden');
        }

        function showPostList() {
            postListElem.classList.remove('hidden');
            postWriteForm.classList.add('hidden');
            postView.classList.add('hidden');
            resetForm();
            renderPostList();
            document.getElementById('writeButton').style.display = 'block';
            document.getElementById('topPostsButton').style.display = 'block';
        }

        function showPostDetail(index) {
            postListElem.classList.add('hidden');
            postWriteForm.classList.add('hidden');
            postView.classList.remove('hidden');
            renderPostDetail(index);
            document.getElementById("writeButton").style.display = "none";
            document.getElementById("topPostsButton").style.display = "none";
        }

        function savePost() {
            const title = document.getElementById('post-title').value;
            const content = document.getElementById('post-content').value;
            const file = document.getElementById('post-image').files[0];
            const youtubeUrl = document.getElementById('youtube-url').value; // 추가

            savedPosts.push({
                title,
                content,
                file,
                youtubeUrl, // 추가
                upVotes: 0,
                downVotes: 0,
                comments: []
            });

            showPostList();
        }

        function renderPostList(posts = savedPosts) {
            postListElem.innerHTML = '';

            posts.forEach((post, index) => {
                postListElem.innerHTML += `
                    <li class="list-group-item" onclick="showPostDetail(${index})">
                        <span>${post.title}</span>
                    </li>`;
            });
        }

        function renderPostDetail(index) {
            currentPostIndex = index;
            const post = savedPosts[index];
            const reader = new FileReader();

            const videoId = getYouTubeVideoId(post.youtubeUrl); // 추가

            reader.onloadend = function () {
                postView.innerHTML = `
                    <h2>${post.title}</h2>
                    <p>${post.content}</p>
                    ${post.file ? `<img src="${reader.result}" alt="" width="200" height="200">` : ''}
                    ${post.youtubeUrl ? `<iframe width="560" height="315" src="https://www.youtube.com/embed/${videoId}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>` : ""}
                    <div class="mt-3">
                        <button id="upvote-count" onclick="upVote(currentPostIndex)" class="btn btn-link">&#128077; ${post.upVotes}</button>
                        <button id="downvote-count" onclick="downVote(currentPostIndex)" class="btn btn-link">&#128078; ${post.downVotes}</button>
                        <button onclick="showPostList()" class="btn btn-secondary">뒤로</button>
                    </div>
                    <div id="comments-section">
                        <h2>댓글 목록</h2>
                        <ul id="comments-list" class="comments-list"></ul>
                        <h5>댓글 작성</h5>
                        <form id="comment-form" onsubmit="addComment(event); return false;">
                            <input type="text" class="form-control" id="comment-text" placeholder="댓글을 입력하세요">
                            <button type="submit" class="btn btn-primary mt-2">댓글달기</button>
                        </form>
                    </div>`;
                renderComments();
            };

            if (post.file) {
                reader.readAsDataURL(post.file);
            } else {
                reader.onloadend();
            }
        }

        // 다음 함수는 수정되지 않았으며 그대로 유지합니다.
        function getYouTubeVideoId(url) {
            const regex = /(?:youtube(?:-nocookie)?\.com\/[^\/\s]+\/|(?:https?:\/\/)?(?:www\.)?(?:youtube.com\/watch\?(?:.*&)v=|(?:youtu\.be\/)))([0-9A-Za-z-_]{11})/;
            const match = url.match(regex);
            return match && match[1] ? match[1] : null;
        }

        renderPostList();

        // 다음 함수들은 수정되지 않았으며 그대로 유지합니다.
        function addComment(event) {
    event.preventDefault();
    const commentText = document.getElementById("comment-text").value;
    const commentAuthor = "사용자 닉네임"; // 사용자가 입력한 닉네임으로 변경해야 합니다.
    const commentTime = new Date().toLocaleString();
    if (commentText.length === 0) {
        alert("댓글 내용을 입력하세요.");
        return;
    }
    savedPosts[currentPostIndex].comments.push({ text: commentText, author: commentAuthor, time: commentTime });
    document.getElementById("comment-text").value = "";
    renderComments();
}

function renderComments() {
    const commentsListElem = document.getElementById('comments-list');
    const comments = savedPosts[currentPostIndex].comments;
    commentsListElem.innerHTML = '';
    comments.forEach((comment, index) => {
        commentsListElem.innerHTML += `<li class="list-group-item"><strong>${comment.author}</strong> (${comment.time}): ${comment.text}</li>`;
    });
}



        function upVote(index) {
            savedPosts[index].upVotes += 1;
            updateVoteCount(index);
        }

        function downVote(index) {
            savedPosts[index].downVotes += 1;
            updateVoteCount(index);
        }

        function updateVoteCount(index) {
            const upvoteCount = document.getElementById('upvote-count');
            const downvoteCount = document.getElementById('downvote-count');
            upvoteCount.innerHTML = `&#128077; ${savedPosts[index].upVotes}`;
            downvoteCount.innerHTML = `&#128078; ${savedPosts[index].downVotes}`;
        }

        function showTopPosts() {
            const topPosts = savedPosts.filter(post => post.upVotes >= 5);
            renderPostList(topPosts);
        }
    </script>
</body>
</html>
